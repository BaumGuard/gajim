before_script:
  - sudo apt-get update -qq && sudo apt-get install -y -qq libtool pkg-config libglib2.0-dev python-openssl $(apt-cache depends gajim-nightly | grep Depends | sed "s/.*ends:\ //" | tr '\n' ' ')
  - sudo apt-get build-dep -y -qq gajim-nightly

stages:
  - test
  - build

run-test:
  stage: test
  script:
    - ./autogen.sh
    - make test_nogui

run-build:
  stage: build
  script:
    - ./autogen.sh
    - make dist
    - export FN="gajim-"$(date +%F)".tar"
    - mv gajim-*.tar.gz $FN.gz
    - mkdir tmp_add_plugins
    - mv $FN.gz tmp_add_plugins/
    - cd tmp_add_plugins/
    - tar xzf $FN.gz
    - rm $FN.gz
    - export GF=$(find . -maxdepth 1 -type d -name 'gajim-*')
    - cd $GF/plugins/
    - curl -O https://ftp.gajim.org/plugins_0.16_zip/plugin_installer.zip
    - unzip plugin_installer.zip
    - rm plugin_installer.zip
    - cd ../..
    - tar czf ../$FN.gz gajim-*
    - cd ..
    - rm -rf tmp_add_plugins
    - scp $FN.gz panoramix:/var/www/gajim/downloads/snap/ci/gajim-$CI_COMMIT_SHA.tar.gz

  artifacts:
    name: "gajim-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA"
    expire_in: 1 week
    paths:
      - gajim-2???-??-??.tar.gz
